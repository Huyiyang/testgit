@{
    Layout = "~/Views/Shared/_Layout.cshtml";

    string cdnFileRoot = CC.ERP.Portal.Global.CDNFileRoot;
    ViewData.Add("cdnFileRoot", cdnFileRoot);
}

@section head{
    <link href="@(cdnFileRoot)/Content/wysihtml5.css" rel="stylesheet" />
    <script src="@(cdnFileRoot)/Scripts/parser_rules/advanced.js"></script>
    <script src="@(cdnFileRoot)/Scripts/wysihtml5-0.4.0pre.js"></script>
}
<div class="container" style="margin-top: 20px">
    <div class="panel panel-default">
        <div class="panel-heading">
            <div style="font-size: 19pt; height: 46px; line-height: 46px;"><span class="glyphicon glyphicon-leaf"></span>&nbsp;&nbsp;<span>用户社区</span></div>
        </div>
        <div class="panel-body">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div><span class="glyphicon glyphicon-pencil"></span>&nbsp;&nbsp;<span>发布新帖</span></div>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <input type="text" id="txt_title" tabindex="1" class="form-control" placeholder="输入标题">
                    </div>
                    <div id="toolbar" style="margin-bottom: 5px;">
                        <div>
                            <span class="btn-group">
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h1">标题1</a>
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h2">标题2</a>
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h3">标题3</a>
                            </span>
                            <span class="btn-group">
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="bold" title="CTRL+B"><strong>B</strong></a>
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="italic" title="CTRL+I"><i>I</i></a>
                            </span>
                            <span class="btn-group">
                                <a class="btn btn-default btn-sm" onclick="(function(m){ return false; })(this)">图片</a>
                                <form id="uploadform" style="position: absolute; left: 0; top: 0; z-index: 10" action="upload?type=img&success=uploadsuccess&error=uploaderror&id=f_insertimg" enctype="multipart/form-data" target="forupdate" method="post">
                                    <input type="file" id="imgfile" name="file" onchange="(function(m){if(!m.value)return;$('#imgfilepath').val(m.value); $(m).parent().submit(); })(this)" style="width: 45px; height: 30px; margin: 0; padding: 0; overflow: hidden; opacity: 0; filter: alpha(opacity=0)" />
                                </form>
                                <a class="btn btn-default btn-sm" style="border-left: none" data-wysihtml5-command="createLink">链接</a>
                            </span>
                            <span class="btn-group">
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="foreColor" data-wysihtml5-command-value="red">红</a>
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="foreColor" data-wysihtml5-command-value="green">绿</a>
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="foreColor" data-wysihtml5-command-value="blue">蓝</a>
                            </span>
                            <span class="btn-group">
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="insertUnorderedList">普通列表</a>
                                <a class="btn btn-default btn-sm" data-wysihtml5-command="insertOrderedList">数字列表</a>
                            </span>
                            <span class="btn-group" style="display: none">
                                <a class="btn btn-default btn-sm" data-wysihtml5-action="change_view">switch to html view</a>
                            </span>
                        </div>
                        <button type="button" id="btn_insertImage" data-wysihtml5-command="insertImage" style="display: none">Insert</button>
                        <div data-wysihtml5-dialog="insertImage" style="position: absolute; top: -11100px">
                            <input id="f_insertimg" data-wysihtml5-dialog-field="src" value="" />
                            <button type="button" id="imguploadbtn" data-wysihtml5-dialog-action="save"></button>
                        </div>
                        <div data-wysihtml5-dialog="createLink" style="display: none; position: absolute">
                            <div class="modal-dialog" style="margin-top: 5px;">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" data-wysihtml5-dialog-action="cancel" class="close"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                        <h4 class="modal-title">插入链接</h4>
                                    </div>
                                    <div class="modal-body">
                                        <input class="form-control" data-wysihtml5-dialog-field="href" value="http://">
                                    </div>
                                    <div class="modal-footer">
                                        <a data-wysihtml5-dialog-action="save" class="btn btn-warning">插入</a>
                                        <a data-wysihtml5-dialog-action="cancel" class="btn btn-default">取消</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <textarea id="txt_content" class="form-control" placeholder="文章内容"></textarea>
                    </div>
                    <div>
                        <div style="display: none" class="alert alert-success" role="alert">...</div>
                        <div style="display: none" class="alert alert-info" role="alert">...</div>
                        <div style="display: none" class="alert alert-warning" role="alert">...</div>
                        <div style="display: none" class="alert alert-danger" role="alert">...</div>
                    </div>
                    <div class="form-group">
                        <div class="controls">
                            <button type="button" onclick="_submit()" class="btn btn-warning">提交</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<iframe name="forupdate" style="display: none"></iframe>
<script>
    function uploadsuccess(id, url) {
        $("#uploadform")[0].reset();
        $("#btn_insertImage").click();
        $("#" + id).val(url);
        $("#imguploadbtn").click();
        $(".alert").fadeOut();
    }
    function uploaderror(msg) {
        $("#uploadform")[0].reset();
        $(".alert.alert-danger").text(msg).fadeIn();
    }
    function _submit() {
        var data = { title: encodeURIComponent($("#txt_title").val()), content: encodeURIComponent($("#txt_content").val()) };
        $(".alert.alert-info").text("正在提交...").fadeIn();
        $.post("add", data, function (rst) {
            $(".alert").fadeOut();
            if (rst.success) {
                location.href = "/club";
            } else {
                $(".alert.alert-danger").text(rst.message).fadeIn();
            }
        });
    }
    $(function () {
        var editor = new wysihtml5.Editor('txt_content', {
            toolbar: "toolbar",
            stylesheets: "/content/wysihtml5.css",
            parserRules: wysihtml5ParserRules
        });
        $("#uploadform").submit(function () {
            $(".alert.alert-info").text("正在上传...").fadeIn();
        });
        $(".form-control").first().focus();
    });
</script>
